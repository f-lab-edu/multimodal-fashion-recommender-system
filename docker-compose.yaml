services:
  fetch-assets:
    image: alpine:3.20
    working_dir: /work
    environment:
      OWNER: f-lab-edu
      REPO: multimodal-fashion-recommender-system
      DATA_ASSETS_VER: d0.1.0
      MODEL_ASSETS_VER: m0.1.0
    volumes:
      - ./data:/work/data
      - ./models:/work/models
      - ./scripts:/work/scripts:ro
    command: ["/bin/sh","-lc","apk add --no-cache curl jq tar && /work/scripts/fetch_assets.sh"]
    restart: "no"

  multimodal-fashion-search:
    image: ghcr.io/f-lab-edu/multimodal-fashion-recommender-system:${APP_VER:-v0.1.0}
    depends_on:
      fetch-assets:
        condition: service_completed_successfully
    ports:
      - "3000:3000"
    environment:
      DB_PATH: /app/data/fashion_items.db
      BM25_PATH: /app/data/bm25_from_item_docs.pkl
      IMAGE_INDEX_PATH: /app/data/image_index_with_ids.faiss
      ALS_CONFIG_PATH: /app/config/als_model.yaml
    volumes:
      - ./data:/app/data:ro
      - ./models:/app/models:ro
      - ./config:/app/config:ro
    restart: unless-stopped
